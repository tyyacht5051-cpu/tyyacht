#!/bin/bash

# í†µì˜ìš”íŠ¸í•™êµ API ì„œë²„ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸
# ë¦¬ëˆ…ìŠ¤ í™˜ê²½ì—ì„œ ì‚¬ìš©

set -e

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ğŸš¢ í†µì˜ìš”íŠ¸í•™êµ API ì„œë²„ ì‹œì‘ ì¤‘...${NC}"

# í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
if [ ! -f ".env" ]; then
    echo -e "${YELLOW}âš ï¸  .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. .env.exampleì„ ì°¸ê³ í•˜ì—¬ ìƒì„±í•´ì£¼ì„¸ìš”.${NC}"
    if [ -f ".env.example" ]; then
        echo -e "${BLUE}ğŸ“‹ .env.exampleì„ .envë¡œ ë³µì‚¬í•©ë‹ˆë‹¤...${NC}"
        cp .env.example .env
        echo -e "${RED}â— .env íŒŒì¼ì˜ ì„¤ì •ê°’ë“¤ì„ ì‹¤ì œ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •í•´ì£¼ì„¸ìš”!${NC}"
        exit 1
    fi
fi

# Node.js ë²„ì „ í™•ì¸
NODE_VERSION=$(node --version 2>/dev/null || echo "not installed")
if [[ $NODE_VERSION == "not installed" ]]; then
    echo -e "${RED}âŒ Node.jsê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.${NC}"
    exit 1
fi

echo -e "${GREEN}âœ… Node.js ë²„ì „: $NODE_VERSION${NC}"

# í•„ìš”í•œ ë””ë ‰í† ë¦¬ ìƒì„±
echo -e "${BLUE}ğŸ“ í•„ìš”í•œ ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤...${NC}"

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
export $(grep -v '^#' .env | xargs)

# ë°ì´í„°ë² ì´ìŠ¤ ë””ë ‰í† ë¦¬ ìƒì„±
if [ ! -z "$DATABASE_PATH" ]; then
    DB_DIR=$(dirname "$DATABASE_PATH")
    if [ ! -d "$DB_DIR" ]; then
        echo -e "${BLUE}ğŸ“‚ ë°ì´í„°ë² ì´ìŠ¤ ë””ë ‰í† ë¦¬ ìƒì„±: $DB_DIR${NC}"
        sudo mkdir -p "$DB_DIR"
        sudo chown $(whoami):$(whoami) "$DB_DIR"
        sudo chmod 755 "$DB_DIR"
    fi
fi

# ì—…ë¡œë“œ ë””ë ‰í† ë¦¬ ìƒì„±
if [ ! -z "$UPLOAD_PATH" ]; then
    if [ ! -d "$UPLOAD_PATH" ]; then
        echo -e "${BLUE}ğŸ“‚ ì—…ë¡œë“œ ë””ë ‰í† ë¦¬ ìƒì„±: $UPLOAD_PATH${NC}"
        sudo mkdir -p "$UPLOAD_PATH"
        sudo chown $(whoami):$(whoami) "$UPLOAD_PATH"
        sudo chmod 755 "$UPLOAD_PATH"
    fi
fi

# ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
if [ ! -z "$LOG_PATH" ]; then
    if [ ! -d "$LOG_PATH" ]; then
        echo -e "${BLUE}ğŸ“‚ ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±: $LOG_PATH${NC}"
        sudo mkdir -p "$LOG_PATH"
        sudo chown $(whoami):$(whoami) "$LOG_PATH"
        sudo chmod 755 "$LOG_PATH"
    fi
fi

# npm íŒ¨í‚¤ì§€ ì„¤ì¹˜ í™•ì¸
if [ ! -d "node_modules" ]; then
    echo -e "${BLUE}ğŸ“¦ npm íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤...${NC}"
    npm install
fi

# TypeScript ì»´íŒŒì¼
echo -e "${BLUE}ğŸ”¨ TypeScriptë¥¼ ì»´íŒŒì¼í•©ë‹ˆë‹¤...${NC}"
npm run build

# PM2ê°€ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
if ! command -v pm2 &> /dev/null; then
    echo -e "${YELLOW}âš ï¸  PM2ê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì „ì—­ìœ¼ë¡œ ì„¤ì¹˜í•©ë‹ˆë‹¤...${NC}"
    sudo npm install -g pm2
fi

# PM2ë¡œ ì„œë²„ ì‹œì‘
echo -e "${GREEN}ğŸš€ PM2ë¡œ ì„œë²„ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...${NC}"

# ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ê°€ ìˆë‹¤ë©´ ì¤‘ì§€
pm2 delete tyyacht-api 2>/dev/null || true

# PM2 ì„¤ì • íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
if [ -f "ecosystem.config.js" ]; then
    pm2 start ecosystem.config.js
else
    # ê¸°ë³¸ PM2 ì‹œì‘
    pm2 start dist/server.js --name "tyyacht-api" \
        --instances 2 \
        --exec-mode cluster \
        --env production \
        --log-file "$LOG_PATH/combined.log" \
        --error-file "$LOG_PATH/error.log" \
        --out-file "$LOG_PATH/out.log"
fi

# PM2 ì €ì¥ ë° ì‹œì‘ ì„¤ì •
pm2 save
pm2 startup

echo -e "${GREEN}âœ… ì„œë²„ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!${NC}"
echo -e "${BLUE}ğŸ“Š ì„œë²„ ìƒíƒœ í™•ì¸: pm2 status${NC}"
echo -e "${BLUE}ğŸ“‹ ë¡œê·¸ í™•ì¸: pm2 logs tyyacht-api${NC}"
echo -e "${BLUE}ğŸ”„ ì„œë²„ ì¬ì‹œì‘: pm2 restart tyyacht-api${NC}"
echo -e "${BLUE}â¹ï¸  ì„œë²„ ì¤‘ì§€: pm2 stop tyyacht-api${NC}"

pm2 status